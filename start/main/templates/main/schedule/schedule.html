{% extends "main/base.html" %}
{% load static %}

{% block title %}Расписание{% endblock title %}

{% block content %}
<h2>График: {{ shop.name }} — {{ month }} / {{ year }}</h2>
<div class="mb-3" style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
    <a href="{% url 'main:schedule' shop.id prev_year prev_month %}" class="btn btn-sm btn-outline-primary">&lt; Предыдущий</a>
    <a href="{% url 'main:schedule' shop.id next_year next_month %}" class="btn btn-sm btn-outline-primary">Следующий &gt;</a>
    <button id="goTodayBtn" class="btn btn-sm btn-secondary" type="button">Сегодня</button>
    
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const btn = document.getElementById('goTodayBtn');
            if (!btn) return;
            btn.addEventListener('click', function(){
                const now = new Date();
                const y = now.getFullYear();
                const m = now.getMonth() + 1; // 1..12
                const tpl = "{% url 'main:schedule' shop.id 9999 99 %}";
                const url = tpl.replace('/9999/99/', `/${y}/${m}/`);
                window.location.href = url;
            });
        });
    </script>
</div>
<table border="1" class="table table-bordered" id="scheduleTable" data-shop-id="{{ shop.id }}">
    <thead>
        <tr>
            <th>Работник</th>
            {% for day in days %}
                <th>{{ day.day }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in schedule_rows %}
            <tr>
                <td>{{ row.worker.name }}</td>
                {% for cell in row.cells %}
                    <td class="schedule-cell" data-worker-id="{{ row.worker.id }}" data-date="{{ cell.date|date:'Y-m-d' }}">
                        {% if cell.shift %}
                            {% if cell.shift.is_plus %}
                                +
                            {% elif cell.shift.another_shop %}
                                {{ cell.shift.another_shop.short_code }}
                            {% elif cell.shift.start_time %}
                                {{ cell.shift.start_time|time:'H:i' }}
                            {% endif %}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

{% csrf_token %}
<div class="modal-window" id="modalWindow">
    <div class="modal-in">
        <div class="modal-buttons">
            <button class="modal-btn d-flex">07:30</button>
            <button class="modal-btn d-flex">08:00</button>
            <button class="modal-btn d-flex">09:30</button>
            <button class="modal-btn d-flex">10:00</button>
            <button class="modal-btn d-flex">+</button>
            {% for cafe in all_shops %}
                {% if cafe.id != shop.id %}
                    <button class="modal-btn-short-codes d-flex">{{ cafe.short_code }}</button>
                {% endif %}
            {% endfor %}
            <button class="modal-btn d-flex">Выходной</button>
            <button class="modal-btn-back d-flex">Отмена</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('modalWindow');
        const tableEl = document.getElementById('scheduleTable');
        let currentCell = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function saveCellValue(cell, text) {
            const url = "{% url 'main:update_shift' %}";
            const payload = {
                coffee_shop_id: tableEl.dataset.shopId,
                worker_id: cell.dataset.workerId,
                date: cell.dataset.date,
                value: text
            };
            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const msg = await resp.text();
                console.error('Save error:', msg);
            }
        }

        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function () {
                currentCell = this;
                modal.style.display = 'flex';
            });
        });

        modal.addEventListener('click', function (event) {
            const btn = event.target.closest('button');
            if (!btn) return;

            const text = btn.textContent.trim();

            if (text === 'Отмена') {
                modal.style.display = 'none';
                return;
            }

            if (text === '+') {
                if (currentCell) {
                    currentCell.textContent = '+';
                    saveCellValue(currentCell, '+').catch(console.error);
                }
                modal.style.display = 'none';
                return;
            }

            if (text === 'Выходной') {
                currentCell.textContent = '';
            } else {
                currentCell.textContent = text;
            }

            saveCellValue(currentCell, currentCell.textContent.trim()).catch(console.error);

            modal.style.display = 'none';
        });

        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
{% endblock content %}