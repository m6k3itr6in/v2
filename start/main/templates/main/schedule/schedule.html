{% extends "main/base.html" %}
{% load static %}

{% block title %}Расписание{% endblock title %}

{% block content %}
<h2>График: {{ shop.name }} — {{ month }} / {{ year }}</h2>
<div class="mb-3" style="margin-bottom:12px; display:flex; gap:8px; align-items:center;">
    <a href="{% url 'main:schedule' shop.slug prev_year prev_month %}" class="btn btn-sm btn-outline-primary">&lt; Предыдущий</a>
    <a href="{% url 'main:schedule' shop.slug next_year next_month %}" class="btn btn-sm btn-outline-primary">Следующий &gt;</a>
    <button id="goTodayBtn" class="btn btn-sm btn-secondary" type="button">Сегодня</button>
</div>
<table border="1" class="table table-bordered" id="scheduleTable" data-shop-id="{{ shop.id }}" data-min-workers="{{ min_workers }}" data-shop-code="{{ shop.short_code }}">
    <thead>
        <tr>
            <th>Работник</th>
            {% for day_info in days_info %}
                {% if day_info.workers_count < min_workers %}
                    <th class="day-header" data-date="{{ day_info.date|date:'Y-m-d' }}" style="background-color: #F08080;">{{ day_info.date.day }}</th>
                {% else %}
                    <th class="day-header" data-date="{{ day_info.date|date:'Y-m-d' }}">{{ day_info.date.day }}</th>
                {% endif %}
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for row in schedule_rows %}
            <tr>
                <td>{{ row.worker.name }}</td>
                {% for cell in row.cells %}
                    <td class="schedule-cell" 
                        data-worker-id="{{ row.worker.id }}"
                        data-date="{{ cell.date|date:'Y-m-d' }}"
                        {% if cell.is_insufficient %}style="background-color: red;"{% endif %}>
                        {% if cell.shift %}
                            {% if cell.shift.is_plus %}
                                +
                            {% elif cell.shift.another_shop %}
                                {{ cell.shift.another_shop.short_code }}
                            {% elif cell.shift.start_time %}
                                {{ cell.shift.start_time|time:'H:i' }}
                            {% endif %}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
    </tbody>
</table>

{% csrf_token %}
<div class="modal-window" id="modalWindow">
    <div class="modal-in">
        <div class="modal-buttons">
            <button class="modal-btn d-flex">07:30</button>
            <button class="modal-btn d-flex">08:00</button>
            <button class="modal-btn d-flex">09:30</button>
            <button class="modal-btn d-flex">10:00</button>
            <button class="modal-btn d-flex">+</button>
            {% for cafe in all_shops %}
                {% if cafe.id != shop.id %}
                    <button class="modal-btn-short-codes d-flex">{{ cafe.short_code }}</button>
                {% endif %}
            {% endfor %}
            <button class="modal-btn d-flex">Выходной</button>
            <button class="modal-btn-back d-flex">Отмена</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        const btn = document.getElementById('goTodayBtn');
        if (!btn) return;
        btn.addEventListener('click', function(){
            const now = new Date();
            const y = now.getFullYear();
            const m = now.getMonth() + 1;
            const tpl = "{% url 'main:schedule' shop.slug 9999 99 %}";
            const url = tpl.replace('/9999/99/', `/${y}/${m}/`);
            window.location.href = url;
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('modalWindow');
        const tableEl = document.getElementById('scheduleTable');
        let currentCell = null;

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function updateDayHeaders() {
            const minWorkers = parseInt(tableEl.dataset.minWorkers);
            const shopCode = tableEl.dataset.shopCode;
            const otherShopCodes = [];
            document.querySelectorAll('.modal-btn-short-codes').forEach(btn => {
                otherShopCodes.push(btn.textContent.trim());
            });
            
            const dayHeaders = document.querySelectorAll('.day-header');
            dayHeaders.forEach(header => {
                const date = header.dataset.date;
                const cells = document.querySelectorAll(`.schedule-cell[data-date="${date}"]`);
                let count = 0;
                
                cells.forEach(cell => {
                    const text = cell.textContent.trim();
                    if (text && text !== '' && (text === shopCode || !otherShopCodes.includes(text))) {
                        count++;
                    }
                });
                
                if (count < minWorkers) {
                    header.style.backgroundColor = '#F08080';
                } else {
                    header.style.backgroundColor = '';
                }
            });
        }

        async function saveCellValue(cell, text) {
            const url = "{% url 'main:update_shift' %}";
            const payload = {
                coffee_shop_id: tableEl.dataset.shopId,
                worker_id: cell.dataset.workerId,
                date: cell.dataset.date,
                value: text
            };
            const resp = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const msg = await resp.text();
                console.error('Save error:', msg);
            } else {
                updateDayHeaders();
            }
        }

        document.querySelectorAll('.schedule-cell').forEach(cell => {
            cell.addEventListener('click', function () {
                currentCell = this;
                modal.style.display = 'flex';
            });
        });

        modal.addEventListener('click', function (event) {
            const btn = event.target.closest('button');
            if (!btn || !currentCell) return;

            const text = btn.textContent.trim();

            if (text === 'Отмена') {
                modal.style.display = 'none';
                return;
            }

            if (text === 'Выходной') {
                currentCell.textContent = '';
                saveCellValue(currentCell, '').catch(console.error);
            } else {
                currentCell.textContent = text;
                saveCellValue(currentCell, text).catch(console.error);
            }

            modal.style.display = 'none';
        });

        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
</script>
{% endblock content %}